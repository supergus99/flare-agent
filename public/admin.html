<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Flare</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/flatly/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 1rem; min-height: 100vh; background: var(--bs-body-bg); }
    .login-card { max-width: 22rem; margin: 3rem auto; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.08); }
    .stat-card { transition: transform .15s ease; }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card .display-6 { font-weight: 700; }
    .table-responsive { border-radius: var(--bs-border-radius); overflow: hidden; }
    .nav-tabs .nav-link { font-weight: 500; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login -->
    <div id="login-box">
      <div class="login-card card border-0">
        <div class="card-body p-4">
          <h1 class="h4 mb-3">Flare Admin</h1>
          <p class="text-muted small mb-3">Sign in with your admin username and password.</p>
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" id="username" class="form-control" placeholder="Username" autocomplete="username">
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" id="password" class="form-control" placeholder="Password" autocomplete="current-password">
          </div>
          <p id="login-error" class="text-danger small mb-2 d-none"></p>
          <button type="button" id="login-btn" class="btn btn-primary w-100">Sign in</button>
        </div>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="admin-panel" class="d-none">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
        <div>
          <h1 class="h4 mb-0">Flare Admin</h1>
          <p class="text-muted small mb-0 mt-1" style="font-size: 0.8rem;">Last updated <span id="admin-last-updated">—</span></p>
          <p class="text-muted small mb-0 mt-0" style="font-size: 0.8rem;">Git: <span id="admin-git-version">—</span></p>
        </div>
        <button type="button" id="logout-btn" class="btn btn-outline-secondary btn-sm">Sign out</button>
      </div>

      <div class="row g-3 mb-4" id="dashboard">
        <div class="col-6 col-md-3">
          <div class="stat-card card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="display-6 text-primary" id="stat-submissions">–</div>
              <div class="text-muted small">Submissions</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="display-6 text-success" id="stat-payments">–</div>
              <div class="text-muted small">Payments</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="display-6 text-info" id="stat-reports">–</div>
              <div class="text-muted small">Reports</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="display-6 text-warning" id="stat-pending">–</div>
              <div class="text-muted small">Pending review</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Purchases & revenue by day (same as STR admin dashboard) -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <h5 class="mb-0 fw-bold">Purchases &amp; revenue by day</h5>
            <small class="text-muted">Completed payments — select a month and switch between count and revenue</small>
          </div>
          <div class="d-flex align-items-center gap-3 flex-wrap">
            <div class="d-flex align-items-center gap-1">
              <button type="button" class="btn btn-sm btn-outline-secondary" id="chart-prev" aria-label="Previous month">‹</button>
              <span class="text-nowrap fw-semibold" id="chart-month-label" style="min-width: 120px; text-align: center;">—</span>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="chart-next" aria-label="Next month" disabled>›</button>
            </div>
            <div class="btn-group btn-group-sm" role="group" aria-label="Chart metric">
              <input type="radio" class="btn-check" name="chartMetric" id="chartMetricPurchases" value="purchases" checked>
              <label class="btn btn-outline-primary" for="chartMetricPurchases">Purchases</label>
              <input type="radio" class="btn-check" name="chartMetric" id="chartMetricRevenue" value="revenue">
              <label class="btn btn-outline-primary" for="chartMetricRevenue">Revenue</label>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div style="position: relative; height: 280px;">
            <canvas id="purchasesRevenueChart" aria-label="Daily purchases or revenue chart"></canvas>
          </div>
          <p class="text-muted small mb-0 mt-2">Default month is the current one; use arrows to compare past months.</p>
        </div>
      </div>

      <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item"><button type="button" class="nav-link active" data-tab="submissions">Submissions</button></li>
        <li class="nav-item"><button type="button" class="nav-link" data-tab="payments">Payments</button></li>
        <li class="nav-item"><button type="button" class="nav-link" data-tab="reports">Reports</button></li>
        <li class="nav-item"><button type="button" class="nav-link" data-tab="templates">Templates</button></li>
        <li class="nav-item"><button type="button" class="nav-link" data-tab="settings">Settings</button></li>
      </ul>

      <div id="tab-submissions" class="tab-content">
        <div class="table-responsive card border-0 shadow-sm">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Name</th><th>Email</th><th>Company</th><th>Service</th><th>Submitted</th><th>Status</th></tr>
            </thead>
            <tbody id="submissions-tbody"></tbody>
          </table>
        </div>
      </div>
      <div id="tab-payments" class="tab-content d-none">
        <div class="table-responsive card border-0 shadow-sm">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Transaction</th><th>Service</th><th>Amount</th><th>Email</th><th>Status</th><th>Created</th></tr>
            </thead>
            <tbody id="payments-tbody"></tbody>
          </table>
        </div>
      </div>
      <div id="tab-reports" class="tab-content d-none">
        <div class="table-responsive card border-0 shadow-sm">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Payment ID</th><th>Type</th><th>Status</th><th>Created</th><th>Action</th></tr>
            </thead>
            <tbody id="reports-tbody"></tbody>
          </table>
        </div>
      </div>
      <div id="tab-templates" class="tab-content d-none">
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-light"><h2 class="h6 mb-0">Report HTML template</h2></div>
          <div class="card-body">
            <p class="text-muted small">Full HTML for the generated report. Placeholders include <code>{{name}}</code> <code>{{company}}</code> <code>{{a.mfa_email}}</code> <code>{{meta.confidence_level}}</code> and many more. Leave empty to use the built-in Flare template.</p>
            <div class="mb-2">
              <button type="button" id="tpl-report-load-default" class="btn btn-outline-primary btn-sm">Load default report template</button>
              <span id="tpl-report-load-message" class="ms-2 text-muted small"></span>
            </div>
            <textarea id="tpl-report-body" class="form-control font-monospace" rows="18" placeholder="<!DOCTYPE html>..."></textarea>
            <div class="mt-2">
              <button type="button" id="tpl-report-preview" class="btn btn-outline-secondary">Preview</button>
              <button type="button" id="tpl-report-save" class="btn btn-primary">Save report template</button>
              <span id="tpl-report-message" class="ms-2 text-muted small"></span>
            </div>
          </div>
        </div>
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-light"><h2 class="h6 mb-0">Assessment HTML template</h2></div>
          <div class="card-body">
            <p class="text-muted small">Full HTML of the assessment page. When set, the public assessment page will load this instead of the default form. Use <strong>Load full template</strong> to load the 10-section Flare assessment, then edit and save. Preview opens the template in a new tab.</p>
            <div class="mb-2">
              <button type="button" id="tpl-assessment-load-full" class="btn btn-outline-primary btn-sm">Load full assessment template</button>
              <span id="tpl-assessment-load-message" class="ms-2 text-muted small"></span>
            </div>
            <textarea id="tpl-assessment-body" class="form-control font-monospace" rows="18" placeholder="<!DOCTYPE html>..."></textarea>
            <div class="mt-2">
              <button type="button" id="tpl-assessment-preview" class="btn btn-outline-secondary">Preview</button>
              <button type="button" id="tpl-assessment-save" class="btn btn-primary">Save assessment template</button>
              <span id="tpl-assessment-message" class="ms-2 text-muted small"></span>
            </div>
          </div>
        </div>
      </div>
      <div id="tab-settings" class="tab-content d-none">
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-light"><h2 class="h6 mb-0">Claude API key</h2></div>
          <div class="card-body">
            <p class="text-muted small mb-2">Anthropic Claude API key for AI-generated report content (executive summary, findings, recommendations). Stored securely in the database. You can also set it via Worker secret <code>CLAUDE_API_KEY</code> or <code>ANTHROPIC_API_KEY</code>; the key from settings takes precedence.</p>
            <div class="mb-2">
              <label for="settings-claude-api-key" class="form-label">Claude API key</label>
              <input type="password" id="settings-claude-api-key" class="form-control form-control-sm font-monospace" placeholder="sk-ant-..." autocomplete="off" style="max-width: 28rem;">
              <div id="settings-claude-status" class="form-text">Status: loading…</div>
            </div>
            <button type="button" id="settings-api-key-save" class="btn btn-primary btn-sm">Save API key</button>
            <span id="settings-api-key-message" class="ms-2 text-muted small"></span>
          </div>
        </div>
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-light"><h2 class="h6 mb-0">AI report instructions</h2></div>
          <div class="card-body">
            <p class="text-muted small mb-2">System instruction sent to Claude when generating report content (executive summary, findings, recommendations). Plain language, no jargon, free tools only, with step-by-step links. Leave empty to use the built-in default.</p>
            <div class="mb-2">
              <button type="button" id="settings-ai-instruction-load-default" class="btn btn-outline-primary btn-sm">Load default instructions</button>
              <span id="settings-ai-instruction-load-message" class="ms-2 text-muted small"></span>
            </div>
            <textarea id="settings-ai-report-instruction" class="form-control font-monospace" rows="22" placeholder="You are a security advisor..."></textarea>
            <div class="mt-2">
              <button type="button" id="settings-ai-instruction-save" class="btn btn-primary btn-sm">Save AI instructions</button>
              <span id="settings-ai-instruction-message" class="ms-2 text-muted small"></span>
            </div>
          </div>
        </div>
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-light"><h2 class="h6 mb-0">Email (Resend)</h2></div>
          <div class="card-body">
            <p class="text-muted small">Check if Resend is configured and working. Sends a test email to the address below.</p>
            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
              <input type="email" id="test-email-to" class="form-control form-control-sm" placeholder="your@email.com" style="max-width:240px;">
              <button type="button" id="test-email-btn" class="btn btn-outline-primary btn-sm">Send test email</button>
              <span id="test-email-message" class="text-muted small"></span>
            </div>
            <hr class="my-3">
            <p class="text-muted small mb-2"><strong>Contact form notifications</strong> – Emails when someone submits the website Contact form are sent to the address set in <code>CONTACT_NOTIFY_EMAIL</code> (Worker secret).</p>
            <div class="d-flex flex-wrap align-items-center gap-2">
              <span id="contact-notify-status" class="text-muted small">…</span>
              <button type="button" id="test-contact-email-btn" class="btn btn-outline-secondary btn-sm">Send test to contact address</button>
              <span id="test-contact-email-message" class="text-muted small"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script>
    (function () {
      if (!window.FLARE_WORKER_URL && /^(www\.)?getflare\.net$/.test(window.location.hostname)) window.FLARE_WORKER_URL = 'https://flare-worker.gusmao-ricardo.workers.dev';
      const WORKER_URL = window.FLARE_WORKER_URL || 'https://flare-worker.gusmao-ricardo.workers.dev';
      const TOKEN_KEY = 'flare_admin_token';

      const loginBox = document.getElementById('login-box');
      const adminPanel = document.getElementById('admin-panel');
      const loginError = document.getElementById('login-error');

      function getToken() { return localStorage.getItem(TOKEN_KEY); }
      function setToken(t) { if (t) localStorage.setItem(TOKEN_KEY, t); else localStorage.removeItem(TOKEN_KEY); }

      function showLogin() {
        loginBox.classList.remove('d-none');
        adminPanel.classList.add('d-none');
      }
      function showPanel() {
        loginBox.classList.add('d-none');
        adminPanel.classList.remove('d-none');
        loadVersionInfo();
      }

      function formatLastUpdated(d) {
        var day = d.getDate();
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var month = months[d.getMonth()];
        var year = d.getFullYear();
        var h = d.getHours();
        var m = String(d.getMinutes()).padStart(2, '0');
        return day + ' ' + month + ' ' + year + ', ' + h + ':' + m;
      }

      async function loadVersionInfo() {
        var lastEl = document.getElementById('admin-last-updated');
        var gitEl = document.getElementById('admin-git-version');
        if (lastEl) lastEl.textContent = formatLastUpdated(new Date());
        if (gitEl) gitEl.textContent = '—';
        try {
          var res = await fetch(WORKER_URL + '/api/version');
          if (!res.ok) return;
          var data = await res.json();
          if (data.lastUpdated && lastEl) lastEl.textContent = data.lastUpdated;
          if (data.git && gitEl) gitEl.textContent = data.git;
        } catch (_) {}
      }

      function authHeaders() {
        const t = getToken();
        return t ? { 'Authorization': 'Bearer ' + t, 'Content-Type': 'application/json' } : {};
      }

      document.getElementById('login-btn').addEventListener('click', async function () {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        loginError.classList.add('d-none');
        if (!username || !password) {
          loginError.textContent = 'Enter username and password';
          loginError.classList.remove('d-none');
          return;
        }
        try {
          const res = await fetch(WORKER_URL + '/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (!res.ok) {
            loginError.textContent = data.error || 'Login failed';
            loginError.classList.remove('d-none');
            return;
          }
          setToken(data.token);
          showPanel();
          loadStats();
          loadTab('submissions');
        } catch (e) {
          loginError.textContent = e.message || 'Network error';
          loginError.classList.remove('d-none');
        }
      });

      document.getElementById('logout-btn').addEventListener('click', function () {
        setToken(null);
        showLogin();
      });

      document.querySelectorAll('[data-tab]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          document.querySelectorAll('[data-tab]').forEach(b => { b.classList.remove('active'); });
          document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
          btn.classList.add('active');
          const tab = btn.getAttribute('data-tab');
          document.getElementById('tab-' + tab).classList.remove('d-none');
          loadTab(tab);
        });
      });

      async function loadTab(tab) {
        if (tab === 'submissions') {
          const res = await fetch(WORKER_URL + '/api/admin/submissions?limit=100', { headers: authHeaders() });
          if (res.status === 401) { setToken(null); showLogin(); return; }
          const data = await res.json();
          loadStats();
          const tbody = document.getElementById('submissions-tbody');
          tbody.innerHTML = (data.data || []).map(function (r) {
            return '<tr><td>' + r.id + '</td><td>' + escapeHtml(r.name || '') + '</td><td>' + escapeHtml(r.email || '') + '</td><td>' + escapeHtml(r.company || '') + '</td><td>' + escapeHtml(r.service || '') + '</td><td>' + escapeHtml(r.submitted_at || '') + '</td><td><span class="badge bg-secondary">' + escapeHtml(r.status || '') + '</span></td></tr>';
          }).join('');
        } else if (tab === 'payments') {
          const res = await fetch(WORKER_URL + '/api/admin/payments?limit=100', { headers: authHeaders() });
          if (res.status === 401) { setToken(null); showLogin(); return; }
          const data = await res.json();
          loadStats();
          const tbody = document.getElementById('payments-tbody');
          tbody.innerHTML = (data.data || []).map(function (r) {
            const statusClass = r.payment_status === 'completed' ? 'bg-success' : r.payment_status === 'failed' ? 'bg-danger' : 'bg-secondary';
            return '<tr><td>' + r.id + '</td><td><code class="small">' + escapeHtml((r.transaction_id || '').slice(0, 24)) + '</code></td><td>' + escapeHtml(r.service_type || '') + '</td><td>' + (r.amount / 100) + ' ' + (r.currency || '') + '</td><td>' + escapeHtml(r.customer_email || '') + '</td><td><span class="badge ' + statusClass + '">' + escapeHtml(r.payment_status || '') + '</span></td><td>' + escapeHtml(r.created_at || '') + '</td></tr>';
          }).join('');
        } else if (tab === 'reports') {
          const res = await fetch(WORKER_URL + '/api/admin/reports?limit=100', { headers: authHeaders() });
          if (res.status === 401) { setToken(null); showLogin(); return; }
          const data = await res.json();
          loadStats();
          const tbody = document.getElementById('reports-tbody');
          tbody.innerHTML = (data.data || []).map(function (r) {
            const viewLink = r.view_hash
              ? '<a href="' + WORKER_URL + '/report?hash=' + encodeURIComponent(r.view_hash) + '" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm me-1">View</a>'
              : '';
            const approveBtn = (r.status === 'pending_review' || r.status === 'approved') && r.status !== 'sent'
              ? '<button type="button" class="approve-btn btn btn-success btn-sm" data-id="' + r.id + '">Approve &amp; send email</button>'
              : '<span class="badge bg-secondary">' + escapeHtml(r.status || '') + '</span>';
            const statusClass = r.status === 'sent' ? 'bg-success' : r.status === 'approved' ? 'bg-info' : r.status === 'pending_review' ? 'bg-warning text-dark' : 'bg-secondary';
            return '<tr><td>' + r.id + '</td><td>' + r.payment_id + '</td><td>' + escapeHtml(r.report_type || '') + '</td><td><span class="badge ' + statusClass + '">' + escapeHtml(r.status || '') + '</span></td><td>' + escapeHtml(r.created_at || '') + '</td><td>' + viewLink + approveBtn + '</td></tr>';
          }).join('');
          tbody.querySelectorAll('.approve-btn').forEach(function (b) {
            b.addEventListener('click', function () {
              const id = b.getAttribute('data-id');
              fetch(WORKER_URL + '/api/admin/reports/' + id + '/approve', { method: 'POST', headers: authHeaders() })
                .then(function (res) { return res.json(); })
                .then(function (d) { alert(d.message || (d.ok ? 'Done' : d.error)); loadTab('reports'); })
                .catch(function (e) { alert(e.message); });
            });
          });
        } else if (tab === 'templates') {
          const rRes = await fetch(WORKER_URL + '/api/admin/report-template', { headers: authHeaders() });
          if (rRes.status === 401) { setToken(null); showLogin(); return; }
          const rData = await rRes.json();
          const reportBody = (rData.data != null && rData.data !== '') ? rData.data : (rData.defaultBody || '');
          document.getElementById('tpl-report-body').value = reportBody;

          const aRes = await fetch(WORKER_URL + '/api/admin/assessment-template', { headers: authHeaders() });
          if (aRes.status === 401) return;
          const aData = await aRes.json();
          const assessmentBody = (aData.body != null && aData.body !== '') ? aData.body : (aData.defaultBody || '');
          document.getElementById('tpl-assessment-body').value = assessmentBody;
        } else if (tab === 'settings') {
          const settingsRes = await fetch(WORKER_URL + '/api/admin/settings', { headers: authHeaders() });
          if (settingsRes.status === 401) { setToken(null); showLogin(); return; }
          try {
            const settingsData = await settingsRes.json();
            const statusEl = document.getElementById('settings-claude-status');
            if (statusEl) statusEl.textContent = settingsData.claude_api_key_set ? 'Status: Configured' : 'Status: Not set';
            const aiEl = document.getElementById('settings-ai-report-instruction');
            if (aiEl) aiEl.value = settingsData.ai_report_instruction ?? '';
          } catch (_) {}
          try {
            const contactRes = await fetch(WORKER_URL + '/api/admin/contact-notify-status', { headers: authHeaders() });
            if (contactRes.ok) {
              const contactData = await contactRes.json();
              const contactStatusEl = document.getElementById('contact-notify-status');
              if (contactStatusEl) contactStatusEl.textContent = contactData.configured ? 'Configured: ' + (contactData.email || '') : 'Not configured. Set CONTACT_NOTIFY_EMAIL secret (e.g. mail@strsecure.com).';
            }
          } catch (_) {}
        }
      }

      function escapeHtml(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      async function loadStats() {
        try {
          const res = await fetch(WORKER_URL + '/api/admin/stats', { headers: authHeaders() });
          if (res.status !== 200) return;
          const data = await res.json();
          document.getElementById('stat-submissions').textContent = data.submissions ?? '–';
          document.getElementById('stat-payments').textContent = data.payments ?? '–';
          document.getElementById('stat-reports').textContent = data.reports ?? '–';
          document.getElementById('stat-pending').textContent = data.reports_pending_review ?? '–';
        } catch (_) {}
      }

      document.getElementById('tpl-assessment-load-full').addEventListener('click', async function () {
        const msg = document.getElementById('tpl-assessment-load-message');
        msg.textContent = 'Loading...';
        try {
          let html = null;
          try {
            const sameOrigin = window.location.origin + '/templates/assessment-full.html';
            const r = await fetch(sameOrigin);
            if (r.ok) html = await r.text();
          } catch (_) {}
          if (!html) {
            const r = await fetch(WORKER_URL + '/api/admin/assessment-template-full', { headers: authHeaders() });
            if (r.ok) html = await r.text();
          }
          if (html && html.trim()) {
            document.getElementById('tpl-assessment-body').value = html;
            msg.textContent = 'Loaded. Edit and click Save to use as the live template.';
          } else {
            msg.textContent = 'Not found. Add public/templates/assessment-full.html to your Flare project (copy from assessment-flare.html in the STR repo) or configure ASSESSMENT_FULL_TEMPLATE_URL in the Worker.';
          }
        } catch (e) {
          msg.textContent = e.message || 'Load failed.';
        }
      });

      document.getElementById('tpl-assessment-save').addEventListener('click', async function () {
        const msg = document.getElementById('tpl-assessment-message');
        msg.textContent = 'Saving...';
        msg.classList.remove('text-danger');
        const body = document.getElementById('tpl-assessment-body').value;
        try {
          const res = await fetch(WORKER_URL + '/api/admin/assessment-template', { method: 'PUT', headers: authHeaders(), body: JSON.stringify({ body: body }) });
          const data = await res.json();
          msg.textContent = res.ok ? 'Saved.' : (data.error || 'Failed');
          if (!res.ok) msg.classList.add('text-danger');
        } catch (e) {
          msg.textContent = e.message || 'Error';
          msg.classList.add('text-danger');
        }
      });

      document.getElementById('settings-api-key-save').addEventListener('click', async function () {
        const msg = document.getElementById('settings-api-key-message');
        const statusEl = document.getElementById('settings-claude-status');
        const input = document.getElementById('settings-claude-api-key');
        msg.textContent = 'Saving…';
        try {
          const res = await fetch(WORKER_URL + '/api/admin/settings', {
            method: 'PUT',
            headers: authHeaders(),
            body: JSON.stringify({ claude_api_key: input.value || '' })
          });
          const data = await res.json();
          if (res.ok) {
            msg.textContent = 'Saved.';
            if (statusEl) statusEl.textContent = (input.value && input.value.trim()) ? 'Status: Configured' : 'Status: Not set';
            input.value = '';
          } else {
            msg.textContent = data.error || 'Failed';
          }
        } catch (e) {
          msg.textContent = e.message || 'Error';
        }
      });

      document.getElementById('settings-ai-instruction-load-default').addEventListener('click', async function () {
        const msg = document.getElementById('settings-ai-instruction-load-message');
        msg.textContent = 'Loading…';
        try {
          const res = await fetch(WORKER_URL + '/api/admin/settings', { headers: authHeaders() });
          if (res.status === 401) { setToken(null); showLogin(); return; }
          const data = await res.json();
          const ta = document.getElementById('settings-ai-report-instruction');
          if (ta && data.ai_report_instruction_default) {
            ta.value = data.ai_report_instruction_default;
            msg.textContent = 'Loaded.';
          } else {
            msg.textContent = 'No default available.';
          }
        } catch (e) {
          msg.textContent = e.message || 'Error';
        }
      });

      document.getElementById('settings-ai-instruction-save').addEventListener('click', async function () {
        const msg = document.getElementById('settings-ai-instruction-message');
        const ta = document.getElementById('settings-ai-report-instruction');
        msg.textContent = 'Saving…';
        msg.classList.remove('text-danger');
        try {
          const res = await fetch(WORKER_URL + '/api/admin/settings', {
            method: 'PUT',
            headers: authHeaders(),
            body: JSON.stringify({ ai_report_instruction: ta ? ta.value : '' })
          });
          const data = await res.json();
          if (res.ok) {
            msg.textContent = 'Saved.';
          } else {
            msg.textContent = data.error || 'Failed';
            msg.classList.add('text-danger');
          }
        } catch (e) {
          msg.textContent = e.message || 'Error';
          msg.classList.add('text-danger');
        }
      });

      document.getElementById('tpl-report-load-default').addEventListener('click', async function () {
        const msg = document.getElementById('tpl-report-load-message');
        msg.textContent = 'Loading...';
        try {
          const res = await fetch(WORKER_URL + '/api/admin/report-template', { headers: authHeaders() });
          if (res.status === 401) { setToken(null); showLogin(); return; }
          const data = await res.json();
          const defaultBody = data.defaultBody || '';
          document.getElementById('tpl-report-body').value = defaultBody;
          msg.textContent = defaultBody ? 'Loaded. Click Save to use as the live template.' : 'No default template returned.';
        } catch (e) {
          msg.textContent = e.message || 'Load failed.';
        }
      });

      document.getElementById('tpl-report-save').addEventListener('click', async function () {
        const msg = document.getElementById('tpl-report-message');
        msg.textContent = 'Saving...';
        const body = document.getElementById('tpl-report-body').value;
        try {
          const res = await fetch(WORKER_URL + '/api/admin/report-template', { method: 'PUT', headers: authHeaders(), body: JSON.stringify({ body: body }) });
          const data = await res.json();
          msg.textContent = res.ok ? 'Saved.' : (data.error || 'Failed');
        } catch (e) {
          msg.textContent = e.message || 'Error';
        }
      });

      function escapeHtmlPreview(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      document.getElementById('tpl-assessment-preview').addEventListener('click', function () {
        let body = document.getElementById('tpl-assessment-body').value;
        if (!body || !body.trim()) {
          alert('Enter assessment HTML to preview.');
          return;
        }
        var previewInject = '<div class="flare-preview-badge" style="background:#fff3cd;color:#856404;padding:.5rem 1rem;font-size:.9rem;margin-bottom:1rem;border-radius:6px;display:flex;align-items:center;justify-content:space-between;gap:1rem;"><span>Preview only – form does not submit.</span><button type="button" id="flare-preview-theme-toggle" style="background:rgba(0,0,0,.1);border:1px solid rgba(0,0,0,.2);border-radius:6px;padding:.35rem .75rem;cursor:pointer;font-size:.9rem;">Light</button></div><style id="flare-preview-theme">[data-theme="light"]{--bg:#f4f4f5;--bg-elevated:#ffffff;--text:#18181b;--text-muted:#71717a;--accent:#0891b2;--accent-soft:rgba(8,145,178,0.15);--border:rgba(0,0,0,0.1);--error:#dc2626;} body:has(.flare-preview-badge) nav #theme-toggle{display:none !important;}</style><script>window.FLARE_PREVIEW=true;</scr' + 'ipt><script>(function(){var t=localStorage.getItem("flare_theme")||"dark";document.documentElement.setAttribute("data-theme",t);document.addEventListener("DOMContentLoaded",function(){var b=document.getElementById("flare-preview-theme-toggle");if(b){b.textContent=t==="light"?"Dark":"Light";b.onclick=function(){t=t==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",t);localStorage.setItem("flare_theme",t);b.textContent=t==="light"?"Dark":"Light";};}});})();</scr' + 'ipt>';
        body = body.replace(/<body(\s[^>]*)?>/i, '<body$1>' + previewInject);
        const w = window.open('', '_blank');
        w.document.write(body);
        w.document.close();
      });

      document.getElementById('tpl-report-preview').addEventListener('click', function () {
        let body = document.getElementById('tpl-report-body').value;
        if (!body || !body.trim()) {
          alert('Enter report HTML to preview, or load the Templates tab again to use the built-in template.');
          return;
        }
        var reportPreviewInject = '<div class="flare-preview-badge" style="background:#fff3cd;color:#856404;padding:.5rem 1rem;font-size:.9rem;margin-bottom:1rem;border-radius:6px;display:flex;align-items:center;justify-content:space-between;gap:1rem;"><span>Preview only – report template.</span><button type="button" id="flare-preview-theme-toggle" style="background:rgba(0,0,0,.1);border:1px solid rgba(0,0,0,.2);border-radius:6px;padding:.35rem .75rem;cursor:pointer;font-size:.9rem;">Light</button></div><style id="flare-preview-theme">[data-theme="light"]{--bg:#f4f4f5;--bg-elevated:#ffffff;--bg-card:#ffffff;--text:#18181b;--text-muted:#71717a;--accent:#0891b2;--accent-soft:rgba(8,145,178,0.15);--border:rgba(0,0,0,0.1);--error:#dc2626;} [data-theme="light"] body,[data-theme="light"] .report,[data-theme="light"] .kpi{background:#f4f4f5 !important;} [data-theme="light"] .card,[data-theme="light"] section.card,[data-theme="light"] section{background:#ffffff !important;} body:has(.flare-preview-badge) #theme-toggle{display:none !important;}</style><script>(function(){var t=localStorage.getItem("flare_theme")||"dark";document.documentElement.setAttribute("data-theme",t);document.addEventListener("DOMContentLoaded",function(){var b=document.getElementById("flare-preview-theme-toggle");if(b){b.textContent=t==="light"?"Dark":"Light";b.onclick=function(){t=t==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",t);localStorage.setItem("flare_theme",t);b.textContent=t==="light"?"Dark":"Light";};}});})();</scr' + 'ipt>';
        body = body.replace(/<body(\s[^>]*)?>/i, '<body$1>' + reportPreviewInject);
        const sample = { name: 'Jane Doe', company: 'Acme Ltd', email: 'jane@acme.example', role: 'Operations Manager', service: 'Risk Analysis & Action Plan', message: 'Sample notes for preview.', report_date: new Date().toISOString().slice(0, 10), website_url: 'https://acme.example', website_href: 'https://acme.example', units_range: '10–50', countries: 'US, CA', language: 'en' };
        body = body.replace(/\{\{name\}\}/g, escapeHtmlPreview(sample.name)).replace(/\{\{company\}\}/g, escapeHtmlPreview(sample.company)).replace(/\{\{email\}\}/g, escapeHtmlPreview(sample.email)).replace(/\{\{role\}\}/g, escapeHtmlPreview(sample.role)).replace(/\{\{service\}\}/g, escapeHtmlPreview(sample.service)).replace(/\{\{message\}\}/g, escapeHtmlPreview(sample.message)).replace(/\{\{report_date\}\}/g, escapeHtmlPreview(sample.report_date)).replace(/\{\{website_url\}\}/g, escapeHtmlPreview(sample.website_url)).replace(/\{\{website_href\}\}/g, escapeHtmlPreview(sample.website_href)).replace(/\{\{units_range\}\}/g, escapeHtmlPreview(sample.units_range)).replace(/\{\{countries\}\}/g, escapeHtmlPreview(sample.countries)).replace(/\{\{language\}\}/g, escapeHtmlPreview(sample.language));
        const w = window.open('', '_blank');
        w.document.write(body);
        w.document.close();
      });

      document.getElementById('test-email-btn').addEventListener('click', async function () {
        var toEl = document.getElementById('test-email-to');
        var msgEl = document.getElementById('test-email-message');
        var btn = document.getElementById('test-email-btn');
        var to = (toEl && toEl.value) ? toEl.value.trim() : '';
        msgEl.textContent = '';
        if (!to) {
          msgEl.textContent = 'Enter an email address.';
          msgEl.classList.remove('text-success');
          msgEl.classList.add('text-danger');
          return;
        }
        btn.disabled = true;
        try {
          var res = await fetch(WORKER_URL + '/api/admin/test-email', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ to: to })
          });
          var data = await res.json().catch(function () { return {}; });
          if (data.ok) {
            msgEl.textContent = 'Sent. Check ' + to + ' (and spam).';
            msgEl.classList.remove('text-danger');
            msgEl.classList.add('text-success');
          } else {
            msgEl.textContent = data.error || 'Failed to send';
            msgEl.classList.remove('text-success');
            msgEl.classList.add('text-danger');
          }
        } catch (e) {
          msgEl.textContent = e.message || 'Request failed';
          msgEl.classList.remove('text-success');
          msgEl.classList.add('text-danger');
        }
        btn.disabled = false;
      });

      document.getElementById('test-contact-email-btn').addEventListener('click', async function () {
        var msgEl = document.getElementById('test-contact-email-message');
        var btn = document.getElementById('test-contact-email-btn');
        msgEl.textContent = '';
        btn.disabled = true;
        try {
          var res = await fetch(WORKER_URL + '/api/admin/test-contact-email', { method: 'POST', headers: authHeaders(), body: '{}' });
          var data = await res.json().catch(function () { return {}; });
          if (data.ok) {
            msgEl.textContent = 'Sent. Check the contact address inbox (and spam).';
            msgEl.classList.remove('text-danger');
            msgEl.classList.add('text-success');
          } else {
            msgEl.textContent = data.error || 'Failed to send';
            msgEl.classList.remove('text-success');
            msgEl.classList.add('text-danger');
          }
        } catch (e) {
          msgEl.textContent = e.message || 'Request failed';
          msgEl.classList.remove('text-success');
          msgEl.classList.add('text-danger');
        }
        btn.disabled = false;
      });

      if (getToken()) {
        showPanel();
        loadStats();
        loadTab('submissions');
        (function initPurchasesRevenueChart() {
          var canvas = document.getElementById('purchasesRevenueChart');
          if (!canvas || typeof Chart === 'undefined') return;
          var currentMonth = new Date();
          function toYYYYMM(d) { return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0'); }
          var chart = null;
          var cachedData = null;
          function getMetric() {
            var r = document.querySelector('input[name="chartMetric"]:checked');
            return r ? r.value : 'purchases';
          }
          function applyMetric() {
            if (!chart || !cachedData) return;
            var metric = getMetric();
            var label = metric === 'purchases' ? 'Purchases' : 'Revenue ($)';
            var data = metric === 'purchases' ? cachedData.purchases : cachedData.revenue;
            var color = metric === 'purchases' ? 'rgba(99, 102, 241, 0.6)' : 'rgba(16, 185, 129, 0.6)';
            var border = metric === 'purchases' ? 'rgb(99, 102, 241)' : 'rgb(16, 185, 129)';
            chart.data.datasets[0] = { label: label, data: data, backgroundColor: color, borderColor: border, borderWidth: 1 };
            chart.options.scales.y.ticks.stepSize = metric === 'purchases' ? 1 : undefined;
            chart.update();
          }
          function loadMonth(YYYYMM) {
            fetch(WORKER_URL + '/api/admin/chart-data?month=' + encodeURIComponent(YYYYMM), { headers: authHeaders() })
              .then(function(r) { return r.json(); })
              .then(function(data) {
                if (data.error || !data.ok) return;
                cachedData = data;
                var labelEl = document.getElementById('chart-month-label');
                if (labelEl) labelEl.textContent = data.monthLabel || YYYYMM;
                var nextBtn = document.getElementById('chart-next');
                if (nextBtn) nextBtn.disabled = (YYYYMM === toYYYYMM(new Date()));
                var metric = getMetric();
                var label = metric === 'purchases' ? 'Purchases' : 'Revenue ($)';
                var values = metric === 'purchases' ? data.purchases : data.revenue;
                var color = metric === 'purchases' ? 'rgba(99, 102, 241, 0.6)' : 'rgba(16, 185, 129, 0.6)';
                var border = metric === 'purchases' ? 'rgb(99, 102, 241)' : 'rgb(16, 185, 129)';
                if (!chart) {
                  chart = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: data.labels, datasets: [{ label: label, data: values, backgroundColor: color, borderColor: border, borderWidth: 1 }] },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: { legend: { display: false } },
                      scales: { x: { title: { display: true, text: 'Day of month' } }, y: { beginAtZero: true, ticks: { stepSize: metric === 'purchases' ? 1 : undefined } } }
                    }
                  });
                } else {
                  chart.data.labels = data.labels;
                  chart.data.datasets[0].label = label;
                  chart.data.datasets[0].data = values;
                  chart.data.datasets[0].backgroundColor = color;
                  chart.data.datasets[0].borderColor = border;
                  chart.options.scales.y.ticks.stepSize = metric === 'purchases' ? 1 : undefined;
                  chart.update();
                }
              })
              .catch(function() {});
          }
          var prevBtn = document.getElementById('chart-prev');
          var nextBtn = document.getElementById('chart-next');
          if (prevBtn) prevBtn.addEventListener('click', function() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            loadMonth(toYYYYMM(currentMonth));
          });
          if (nextBtn) nextBtn.addEventListener('click', function() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            loadMonth(toYYYYMM(currentMonth));
          });
          document.querySelectorAll('input[name="chartMetric"]').forEach(function(el) {
            el.addEventListener('change', applyMetric);
          });
          loadMonth(toYYYYMM(currentMonth));
        })();
      } else {
        showLogin();
      }
    })();
  </script>
</body>
</html>
