<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Flare</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/flatly/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 1rem; min-height: 100vh; background: var(--bs-body-bg); }
    .login-card { max-width: 22rem; margin: 3rem auto; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.08); }
    .stat-card { transition: transform .15s ease; }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card .display-6 { font-weight: 700; }
    .table-responsive { border-radius: var(--bs-border-radius); overflow: hidden; }
    .nav-tabs .nav-link { font-weight: 500; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login -->
    <div id="login-box">
      <div class="login-card card border-0">
        <div class="card-body p-4">
          <h1 class="h4 mb-3">Flare Admin</h1>
          <p class="text-muted small mb-3">Sign in with your admin username and password.</p>
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" id="username" class="form-control" placeholder="Username" autocomplete="username">
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" id="password" class="form-control" placeholder="Password" autocomplete="current-password">
          </div>
          <p id="login-error" class="text-danger small mb-2 d-none"></p>
          <button type="button" id="login-btn" class="btn btn-primary w-100">Sign in</button>
        </div>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="admin-panel" class="d-none">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
        <h1 class="h4 mb-0">Flare Admin</h1>
        <button type="button" id="logout-btn" class="btn btn-outline-secondary btn-sm">Sign out</button>
      </div>

      <div class="row g-3 mb-4" id="dashboard">
        <div class="col-6 col-md-3">
          <div class="stat-card card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="display-6 text-primary" id="stat-submissions">–</div>
              <div class="text-muted small">Submissions</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="display-6 text-success" id="stat-payments">–</div>
              <div class="text-muted small">Payments</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="display-6 text-info" id="stat-reports">–</div>
              <div class="text-muted small">Reports</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="display-6 text-warning" id="stat-pending">–</div>
              <div class="text-muted small">Pending review</div>
            </div>
          </div>
        </div>
      </div>

      <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item"><button type="button" class="nav-link active" data-tab="submissions">Submissions</button></li>
        <li class="nav-item"><button type="button" class="nav-link" data-tab="payments">Payments</button></li>
        <li class="nav-item"><button type="button" class="nav-link" data-tab="reports">Reports</button></li>
        <li class="nav-item"><button type="button" class="nav-link" data-tab="templates">Templates</button></li>
      </ul>

      <div id="tab-submissions" class="tab-content">
        <div class="table-responsive card border-0 shadow-sm">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Name</th><th>Email</th><th>Company</th><th>Service</th><th>Submitted</th><th>Status</th></tr>
            </thead>
            <tbody id="submissions-tbody"></tbody>
          </table>
        </div>
      </div>
      <div id="tab-payments" class="tab-content d-none">
        <div class="table-responsive card border-0 shadow-sm">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Transaction</th><th>Service</th><th>Amount</th><th>Email</th><th>Status</th><th>Created</th></tr>
            </thead>
            <tbody id="payments-tbody"></tbody>
          </table>
        </div>
      </div>
      <div id="tab-reports" class="tab-content d-none">
        <div class="table-responsive card border-0 shadow-sm">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Payment ID</th><th>Type</th><th>Status</th><th>Created</th><th>Action</th></tr>
            </thead>
            <tbody id="reports-tbody"></tbody>
          </table>
        </div>
      </div>
      <div id="tab-templates" class="tab-content d-none">
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-light"><h2 class="h6 mb-0">Assessment form template</h2></div>
          <div class="card-body">
            <p class="text-muted small">Edit title, intro, and form fields. Field names (company_name, contact_name, email, role, message) must stay the same for submissions to work.</p>
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input type="text" id="tpl-assessment-title" class="form-control" placeholder="Security assessment">
            </div>
            <div class="mb-3">
              <label class="form-label">Intro text</label>
              <textarea id="tpl-assessment-intro" class="form-control" rows="2" placeholder="Complete this form..."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Hash warning (no access code)</label>
              <input type="text" id="tpl-assessment-hash-warning" class="form-control" placeholder="No access code in the URL...">
            </div>
            <div class="mb-3">
              <label class="form-label">Submit button label</label>
              <input type="text" id="tpl-assessment-submit-label" class="form-control" placeholder="Submit assessment">
            </div>
            <div id="tpl-assessment-fields-container"></div>
            <button type="button" id="tpl-assessment-save" class="btn btn-primary">Save assessment template</button>
            <span id="tpl-assessment-message" class="ms-2 text-muted small"></span>
          </div>
        </div>
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-light"><h2 class="h6 mb-0">Report HTML template</h2></div>
          <div class="card-body">
            <p class="text-muted small">Use placeholders: <code>{{name}}</code> <code>{{company}}</code> <code>{{email}}</code> <code>{{service}}</code> <code>{{message}}</code> <code>{{report_date}}</code>. Leave empty to use built-in template.</p>
            <textarea id="tpl-report-body" class="form-control font-monospace" rows="18" placeholder="<!DOCTYPE html>..."></textarea>
            <div class="mt-2">
              <button type="button" id="tpl-report-save" class="btn btn-primary">Save report template</button>
              <span id="tpl-report-message" class="ms-2 text-muted small"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      if (!window.FLARE_WORKER_URL && /^(www\.)?getflare\.net$/.test(window.location.hostname)) window.FLARE_WORKER_URL = 'https://api.getflare.net';
      const WORKER_URL = window.FLARE_WORKER_URL || 'https://flare-worker.gusmao-ricardo.workers.dev';
      const TOKEN_KEY = 'flare_admin_token';

      const loginBox = document.getElementById('login-box');
      const adminPanel = document.getElementById('admin-panel');
      const loginError = document.getElementById('login-error');

      function getToken() { return localStorage.getItem(TOKEN_KEY); }
      function setToken(t) { if (t) localStorage.setItem(TOKEN_KEY, t); else localStorage.removeItem(TOKEN_KEY); }

      function showLogin() {
        loginBox.classList.remove('d-none');
        adminPanel.classList.add('d-none');
      }
      function showPanel() {
        loginBox.classList.add('d-none');
        adminPanel.classList.remove('d-none');
      }

      function authHeaders() {
        const t = getToken();
        return t ? { 'Authorization': 'Bearer ' + t, 'Content-Type': 'application/json' } : {};
      }

      document.getElementById('login-btn').addEventListener('click', async function () {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        loginError.classList.add('d-none');
        if (!username || !password) {
          loginError.textContent = 'Enter username and password';
          loginError.classList.remove('d-none');
          return;
        }
        try {
          const res = await fetch(WORKER_URL + '/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (!res.ok) {
            loginError.textContent = data.error || 'Login failed';
            loginError.classList.remove('d-none');
            return;
          }
          setToken(data.token);
          showPanel();
          loadStats();
          loadTab('submissions');
        } catch (e) {
          loginError.textContent = e.message || 'Network error';
          loginError.classList.remove('d-none');
        }
      });

      document.getElementById('logout-btn').addEventListener('click', function () {
        setToken(null);
        showLogin();
      });

      document.querySelectorAll('[data-tab]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          document.querySelectorAll('[data-tab]').forEach(b => { b.classList.remove('active'); });
          document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
          btn.classList.add('active');
          const tab = btn.getAttribute('data-tab');
          document.getElementById('tab-' + tab).classList.remove('d-none');
          loadTab(tab);
        });
      });

      async function loadTab(tab) {
        if (tab === 'submissions') {
          const res = await fetch(WORKER_URL + '/api/admin/submissions?limit=100', { headers: authHeaders() });
          if (res.status === 401) { setToken(null); showLogin(); return; }
          const data = await res.json();
          loadStats();
          const tbody = document.getElementById('submissions-tbody');
          tbody.innerHTML = (data.data || []).map(function (r) {
            return '<tr><td>' + r.id + '</td><td>' + escapeHtml(r.name || '') + '</td><td>' + escapeHtml(r.email || '') + '</td><td>' + escapeHtml(r.company || '') + '</td><td>' + escapeHtml(r.service || '') + '</td><td>' + escapeHtml(r.submitted_at || '') + '</td><td><span class="badge bg-secondary">' + escapeHtml(r.status || '') + '</span></td></tr>';
          }).join('');
        } else if (tab === 'payments') {
          const res = await fetch(WORKER_URL + '/api/admin/payments?limit=100', { headers: authHeaders() });
          if (res.status === 401) { setToken(null); showLogin(); return; }
          const data = await res.json();
          loadStats();
          const tbody = document.getElementById('payments-tbody');
          tbody.innerHTML = (data.data || []).map(function (r) {
            const statusClass = r.payment_status === 'completed' ? 'bg-success' : r.payment_status === 'failed' ? 'bg-danger' : 'bg-secondary';
            return '<tr><td>' + r.id + '</td><td><code class="small">' + escapeHtml((r.transaction_id || '').slice(0, 24)) + '</code></td><td>' + escapeHtml(r.service_type || '') + '</td><td>' + (r.amount / 100) + ' ' + (r.currency || '') + '</td><td>' + escapeHtml(r.customer_email || '') + '</td><td><span class="badge ' + statusClass + '">' + escapeHtml(r.payment_status || '') + '</span></td><td>' + escapeHtml(r.created_at || '') + '</td></tr>';
          }).join('');
        } else if (tab === 'reports') {
          const res = await fetch(WORKER_URL + '/api/admin/reports?limit=100', { headers: authHeaders() });
          if (res.status === 401) { setToken(null); showLogin(); return; }
          const data = await res.json();
          loadStats();
          const tbody = document.getElementById('reports-tbody');
          tbody.innerHTML = (data.data || []).map(function (r) {
            const approveBtn = (r.status === 'pending_review' || r.status === 'approved') && r.status !== 'sent'
              ? '<button type="button" class="approve-btn btn btn-success btn-sm" data-id="' + r.id + '">Approve &amp; send email</button>'
              : '<span class="badge bg-secondary">' + escapeHtml(r.status || '') + '</span>';
            const statusClass = r.status === 'sent' ? 'bg-success' : r.status === 'approved' ? 'bg-info' : r.status === 'pending_review' ? 'bg-warning text-dark' : 'bg-secondary';
            return '<tr><td>' + r.id + '</td><td>' + r.payment_id + '</td><td>' + escapeHtml(r.report_type || '') + '</td><td><span class="badge ' + statusClass + '">' + escapeHtml(r.status || '') + '</span></td><td>' + escapeHtml(r.created_at || '') + '</td><td>' + approveBtn + '</td></tr>';
          }).join('');
          tbody.querySelectorAll('.approve-btn').forEach(function (b) {
            b.addEventListener('click', function () {
              const id = b.getAttribute('data-id');
              fetch(WORKER_URL + '/api/admin/reports/' + id + '/approve', { method: 'POST', headers: authHeaders() })
                .then(function (res) { return res.json(); })
                .then(function (d) { alert(d.message || (d.ok ? 'Done' : d.error)); loadTab('reports'); })
                .catch(function (e) { alert(e.message); });
            });
          });
        } else if (tab === 'templates') {
          const aRes = await fetch(WORKER_URL + '/api/admin/assessment-template', { headers: authHeaders() });
          if (aRes.status === 401) { setToken(null); showLogin(); return; }
          const aData = await aRes.json();
          const a = aData.data || {};
          document.getElementById('tpl-assessment-title').value = a.title || '';
          document.getElementById('tpl-assessment-intro').value = a.intro || '';
          document.getElementById('tpl-assessment-hash-warning').value = a.hashWarning || '';
          document.getElementById('tpl-assessment-submit-label').value = a.submitLabel || 'Submit assessment';
          const fields = (a.fields || []).slice().sort(function (x, y) { return (x.order || 0) - (y.order || 0); });
          const container = document.getElementById('tpl-assessment-fields-container');
          container.innerHTML = '<table class="table table-sm"><thead><tr><th>Name</th><th>Label</th><th>Type</th><th>Required</th><th>Placeholder</th></tr></thead><tbody id="tpl-assessment-fields-tbody"></tbody></table>';
          const tbody = document.getElementById('tpl-assessment-fields-tbody');
          tbody.innerHTML = fields.map(function (f, i) {
            return '<tr><td><input type="text" class="form-control form-control-sm tpl-field-name" value="' + escapeHtml(f.name || '') + '" readonly></td><td><input type="text" class="form-control form-control-sm tpl-field-label" value="' + escapeHtml(f.label || '') + '"></td><td><input type="text" class="form-control form-control-sm tpl-field-type" value="' + escapeHtml(f.type || 'text') + '" placeholder="text|email|textarea"></td><td><select class="form-select form-select-sm tpl-field-required"><option value="true"' + (f.required ? ' selected' : '') + '>Yes</option><option value="false"' + (!f.required ? ' selected' : '') + '>No</option></select></td><td><input type="text" class="form-control form-control-sm tpl-field-placeholder" value="' + escapeHtml(f.placeholder || '') + '"></td></tr>';
          }).join('');
          const rRes = await fetch(WORKER_URL + '/api/admin/report-template', { headers: authHeaders() });
          if (rRes.status === 401) return;
          const rData = await rRes.json();
          const reportBody = (rData.data != null && rData.data !== '') ? rData.data : (rData.defaultBody || '');
          document.getElementById('tpl-report-body').value = reportBody;
        }
      }

      function escapeHtml(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      async function loadStats() {
        try {
          const res = await fetch(WORKER_URL + '/api/admin/stats', { headers: authHeaders() });
          if (res.status !== 200) return;
          const data = await res.json();
          document.getElementById('stat-submissions').textContent = data.submissions ?? '–';
          document.getElementById('stat-payments').textContent = data.payments ?? '–';
          document.getElementById('stat-reports').textContent = data.reports ?? '–';
          document.getElementById('stat-pending').textContent = data.reports_pending_review ?? '–';
        } catch (_) {}
      }

      document.getElementById('tpl-assessment-save').addEventListener('click', async function () {
        const msg = document.getElementById('tpl-assessment-message');
        msg.textContent = 'Saving...';
        const tbody = document.getElementById('tpl-assessment-fields-tbody');
        const rows = tbody ? tbody.querySelectorAll('tr') : [];
        const fields = Array.from(rows).map(function (row, i) {
          return {
            name: (row.querySelector('.tpl-field-name') && row.querySelector('.tpl-field-name').value) || ('field_' + i),
            label: (row.querySelector('.tpl-field-label') && row.querySelector('.tpl-field-label').value) || '',
            type: (row.querySelector('.tpl-field-type') && row.querySelector('.tpl-field-type').value) || 'text',
            required: (row.querySelector('.tpl-field-required') && row.querySelector('.tpl-field-required').value) === 'true',
            placeholder: (row.querySelector('.tpl-field-placeholder') && row.querySelector('.tpl-field-placeholder').value) || '',
            order: i + 1
          };
        });
        const formConfig = {
          title: document.getElementById('tpl-assessment-title').value || 'Security assessment',
          intro: document.getElementById('tpl-assessment-intro').value || '',
          hashWarning: document.getElementById('tpl-assessment-hash-warning').value || '',
          submitLabel: document.getElementById('tpl-assessment-submit-label').value || 'Submit assessment',
          fields: fields
        };
        try {
          const res = await fetch(WORKER_URL + '/api/admin/assessment-template', { method: 'PUT', headers: authHeaders(), body: JSON.stringify({ form_config: formConfig }) });
          const data = await res.json();
          msg.textContent = res.ok ? 'Saved.' : (data.error || 'Failed');
        } catch (e) {
          msg.textContent = e.message || 'Error';
        }
      });

      document.getElementById('tpl-report-save').addEventListener('click', async function () {
        const msg = document.getElementById('tpl-report-message');
        msg.textContent = 'Saving...';
        const body = document.getElementById('tpl-report-body').value;
        try {
          const res = await fetch(WORKER_URL + '/api/admin/report-template', { method: 'PUT', headers: authHeaders(), body: JSON.stringify({ body: body }) });
          const data = await res.json();
          msg.textContent = res.ok ? 'Saved.' : (data.error || 'Failed');
        } catch (e) {
          msg.textContent = e.message || 'Error';
        }
      });

      if (getToken()) {
        showPanel();
        loadStats();
        loadTab('submissions');
      } else {
        showLogin();
      }
    })();
  </script>
</body>
</html>
